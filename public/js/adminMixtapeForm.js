"use strict";function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,r=Array(e.length);t<e.length;t++)r[t]=e[t];return r}return Array.from(e)}var form=document.querySelector(".dashboard__edit-article"),titleInput=form.querySelector('[name="title"]'),artistsInput=form.querySelector('[name="artists"]'),descriptionInput=form.querySelector('[name="description"]'),releaseDateInput=form.querySelector('[name="releaseDate"]'),publishedInput=form.querySelector('[name="published"]'),mixtapeType=form.querySelector('[name="mixtape-type"]'),mixtapeTypeFiles=form.querySelector(".dashboard__edit-mixtape--type--files"),mixtapeTypeLink=form.querySelector(".dashboard__edit-mixtape--type--link"),linkInput=form.querySelector('[name="externalLink"]'),zipInput=form.querySelector('[name="zip"]'),artworkInput=form.querySelector('[name="coverImage"]'),artworkImage=form.querySelector(".dashboard__edit-mixtape--artwork"),progressBar=form.querySelector("progress"),progressBarText=form.querySelector(".progress-bar__percent-completed"),progressBarContainer=form.querySelector(".progress-bar"),formErrors=form.querySelector(".form-errors"),trackListings=form.querySelector(".mixtapes__track-listing"),addTrackButton=form.querySelector(".mixtapes__track-listing--add-track"),lightbox=document.querySelector(".lightbox"),deleteButton=document.querySelector("#dashboard__edit-video--delete"),closeLightboxButton=document.querySelector(".lightbox__modal--cancel"),defaultArtwork=artworkImage.src;function submitForm(e){e.preventDefault(),updateTrackListingStateFromDOM();var t=new FormData;t.append("title",titleInput.value),t.append("artists",artistsInput.value),t.append("description",descriptionInput.value),t.append("published",publishedInput.checked),t.append("releaseDate",releaseDateInput.value),t.append("type",mixtapeType.value.toLowerCase()),t.append("trackListing",JSON.stringify(trackListingState));var r=[];if("Files"===mixtapeType.value&&(zipInput.files&&zipInput.files[0]?t.append("zip",zipInput.files[0]):r.push("Please upload zip files")),"Link"===mixtapeType.value&&(linkInput.value.length>0?t.append("externalLink",linkInput.value):r.push("Please add a link to the mixtape")),artworkInput.files&&artworkInput.files[0]&&t.append("artwork",artworkInput.files[0]),(artworkInput.files[0]||zipInput.files[0])&&progressBarContainer.classList.remove("hidden"),r.length)return errorFlash(r);axios.post(window.location.href,t,{onUploadProgress:function(e){var t=Math.floor(100*e.loaded/e.total);progressBar.value=t,progressBarText.innerText=t+"%"}}).then(function(e){window.location="/admin/mixtapes"}).catch(function(e){console.log(e),errorFlash([e.response.data.error])})}function errorFlash(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];formErrors.innerHTML="",0!==e.length&&"undefined"!==e[0]||(e=["An error occurred, please try again"]),e.forEach(function(e){void 0===e&&(e="An error occured");var t=document.createElement("p");t.innerText=e,formErrors.appendChild(t)})}function handleTypeChange(){"Files"===mixtapeType.value?(mixtapeTypeFiles.classList.remove("hidden"),mixtapeTypeFiles.attributes.required=!0,mixtapeTypeLink.classList.add("hidden"),mixtapeTypeLink.attributes.required=!1):(mixtapeTypeLink.classList.remove("hidden"),mixtapeTypeLink.attributes.required=!0,mixtapeTypeFiles.classList.add("hidden"),mixtapeTypeFiles.attributes.required=!1)}form.addEventListener("submit",function(e){submitForm(e)}),handleTypeChange(),mixtapeType.addEventListener("change",handleTypeChange),artworkInput.addEventListener("change",function(e){if(artworkInput.files&&artworkInput.files[0]){var t=new FileReader;t.onload=function(e){artworkImage.src=e.target.result,artworkImage.classList.remove("hidden")},t.readAsDataURL(artworkInput.files[0])}else artworkImage.src=defaultArtwork}),deleteButton&&(deleteButton.addEventListener("click",function(){return lightbox.classList.toggle("active")}),closeLightboxButton.addEventListener("click",function(){return lightbox.classList.toggle("active")}));var trackListingState=[];function setState(e){e!=trackListingState&&(trackListingState=e,renderState())}function renderState(){var e="";trackListingState.forEach(function(t,r){e+=generateListingMarkup(t,r)}),trackListings.innerHTML=e,getTrackListingEntries().forEach(function(e,t){e.querySelector(".mixtapes__track-listing--entry--delete").addEventListener("click",function(e){e.target.parentElement.remove(),updateTrackListingStateFromDOM()})})}function generateListingMarkup(e,t){return'\n  <div class="mixtapes__track-listing--entry" draggable="true" ondragstart="dragTrack(event)" ondrop="dropTrack(event)" ondragover="allowDrop(event)" data-key="'+t+'">\n    <div class="mixtapes__track-listing--entry--number">\n      '+t+'\n    </div>\n    <input value="'+e.title+'" oninput="updateTrackListingStateFromDOM(false)" type="text" class="mixtapes__track-listing--entry--title">\n    <input value="'+e.duration+'" oninput="updateTrackListingStateFromDOM(false)" type="text" class="mixtapes__track-listing--entry--duration">\n    <div class="mixtapes__track-listing--entry--delete">\n      âœ•\n    </div>\n  </div>'}function getTrackListingData(e){var t=e.querySelector(".mixtapes__track-listing--entry--title").value,r=e.querySelector(".mixtapes__track-listing--entry--duration").value,a=new RegExp(/([0-9]{1,2}:[0-9]{2})/);return r.match(a)||(r="0:00"),{title:t,duration:r}}function getTrackListingEntries(){return trackListings.querySelectorAll(".mixtapes__track-listing--entry")}function updateTrackListingStateFromDOM(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],t=[];getTrackListingEntries().forEach(function(e,r){var a=getTrackListingData(e),i=a.title,n=a.duration;t.push({title:i,duration:n})}),e?setState(t):trackListingState=t}function dragTrack(e){e.dataTransfer.setData("start",e.target.getAttribute("data-key"))}function dropTrack(e){e.preventDefault();var t=e.dataTransfer.getData("start"),r=e.target.classList.contains("mixtapes__track-listing--entry")?e.target.getAttribute("data-key"):e.target.parentElement.getAttribute("data-key"),a=[].concat(_toConsumableArray(trackListingState)),i=a.splice(t,1);a.splice(r,0,i[0]),setState(a)}function allowDrop(e){e.preventDefault()}updateTrackListingStateFromDOM(),addTrackButton.addEventListener("click",function(){updateTrackListingStateFromDOM(),trackListingState.push({title:"",duration:"0:00"}),renderState()});